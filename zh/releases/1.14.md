

# PX4-Autopilot v1.14 发布说明

## 升级前必读

v1.14版本对从旧版本升级的用户引入了一些不兼容的变更，特别是我们不再使用mixer文件来定义机体几何结构、电机映射和执行器。

此外，我们弃用了ROS 2使用的Fast-RTPS接口，改用一种更简洁的解决方案，该方案不需要自定义构建目标，并去除了额外的消息生成步骤。

请继续阅读[升级指南](#升级指南)。

## 重大变更

- 动态控制分配  
- 改进的飞行前故障检查报告  
- 故障安全机制简化与模拟  
- 默认模拟环境现已更新为新Gazebo  
- 借助uXRCE-DDS改进的ROS 2接口

### 动态控制分配

我们非常兴奋默认启用新的[动态控制分配](../concept/control_allocation.md)；它允许用户在运行时定义机体配置，而无需混合文件，这得益于QGroundControl中的新[机体设置仪表板](../config/actuators.md)。

::: info
新的执行器配置UI可在QGroundControl 4.2.0或更高版本中使用。
:::

### 改进的预飞故障检查报告（QGC Arming Check Report）

PX4 v1.14通过[事件接口](../concept/events_interface.md)大幅改进了预飞故障的报告功能。  
如果机体无法启动，您可以在[QGC Arming Check Report](https://docs.qgroundcontrol.com/master/en/qgc-user-guide/fly_view/fly_view.html#arm)中更轻松地找出原因。  
无需再猜测是安全开关的问题、校准不佳，还是估算器内部的问题！

::: info  
QGC Arming Check Report UI 可在 **QGC每日构建版本** (QGC v4.2.0及更高版本) 中使用  
:::

作为此次更新的一部分，现在在未启动状态下可以切换到任何模式（此前若没有良好的定位信息，无法切换到需要GPS的模式）。  
PX4仅允许在当前模式的条件满足时启动，并将与当前模式无关的失败检查报告为警告。

欲了解更多信息，请参见：[QGroundControl飞行就绪状态](../flying/pre_flight_checks.md)。

### 失效保护简化

[安全失效保护](../config/safety.md) 处理流程已简化，特别是在已有失效保护正在进行时触发新失效保护的情形处理上。

- 执行动作前新增了保持延迟，为用户留出覆盖失效保护的响应时间。
- 当多个失效保护同时触发时，将执行更严重级别的动作。
  例如当遥控和GPS同时丢失，且遥控丢失设置为返回模式、地面站连接丢失设置为降落时，系统将执行降落操作。

新增的[Failsafe State Machine Simulation](../config/safety_simulation.md) 可用于在所有可能配置和条件下测试失效保护行为。

### 新版 Gazebo

鉴于 [Open Robotics 模拟团队最近的变更](https://discourse.ros.org/t/a-new-era-for-gazebo-cross-post/25012)，我们从 v1.14 开始对 Gazebo 模拟名称进行了调整，以匹配 Open Robotics 的命名规范：

- [Ignition Gazebo](https://docs.px4.io/v1.13/en/simulation/ignition_gazebo.html) 至 [Gazebo](../sim_gazebo_gz/index.md)
- [Gazebo](https://docs.px4.io/v1.13/en/simulation/gazebo.html) 至 [Gazebo Classic](../sim_gazebo_classic/index.md)

最重要的是这也影响了 PX4 的构建目标名称：

- Gazebo 目标现在以 `gz_` 为前缀（例如 `make px4_sitl gz_x500`）。
- Gazebo Classic 的 `make` 目标现在以 `gazebo-classic_` 为前缀（例如 `make px4_sitl gazebo-classic_cloudship`）。

### 通过 uXRCE-DDS 改进的 ROS 2 接口

我们更新了 ROS 2 接口，将 [Fast-RTPS](https://docs.px4.io/v1.13/en/middleware/micrortps.html) 替换为 [uXRCE-DDS](../ros2/user_guide.md)，从而在整体上提供了更好的体验。  
此更改还避免了对 `_rtps` 构建目标的需求，从而默认情况下在更多目标上启用该接口。

## 升级指南

对于从旧版本升级的用户，请花时间查阅以下内容：

1. 执行器更改要求您验证机体几何形状和电机/舵机映射是否与您的机体匹配。在QGC中找到[执行器配置仪表板](../config/actuators.md)，并确认机体几何形状与实际值一致，同时更新电机配置并确保电机和舵机按实际接线方式映射到输出端口，并指定正确的电调类型。注意：请利用UI中的滑块控件。它们可用于验证电机接线。

   如果使用PWM电调电机，我们强烈建议运行[电调校准](../advanced_config/esc_calibration.md)，然后在执行器UI中设置适当的未上锁最小和最大值。

   如果您使用自定义混控文件或早期版本中分配的机体类型不在PX4 v1.14中，校准至关重要。

   然而，即使您使用的机体与[机体参考](../airframes/airframe_reference.md)中特定机体（如[Holybro X500 V2](../airframes/airframe_reference.md#copter_quadrotor_x_holybro_x500_v2)）完全匹配，仍然建议进行电调校准，因为您的接线和电调校准可能与默认值不一致。

1. 默认未上锁PWM值已从900us更改为1000us。
   如果您之前使用过默认PWM未上锁值，请验证更改是否影响您的配置。
   更多细节可参考[电调校准第7步](../advanced_config/esc_calibration.md#steps)相关文档。

1. Fast-RTPS用户必须将代码移植到新的uXRCE-DDS接口。
   应用代码通常只需进行小幅修改。其中包括（至少）：

修改主题名称以匹配新的命名模式，该模式从`fmu/<topic_name>/out`更改为`fmu/out/<topic_name>`，以及[调整QoS设置](../ros2/user_guide.md#ros-2-subscriber-qos-settings)。

更多信息请参见[Fast-RTPS到uXRCE-DDS迁移指南](../middleware/uxrce_dds.md#fast-rtps-to-uxrce-dds-migration-guidelines)

## 其他更改

### 硬件支持

- Cubepilot Cube Orange+ - [PX4-Autopilot#20304](https://github.com/PX4/PX4-Autopilot/pull/20304)
- Unicore GPS：Holybro Unicore UM982 GPS支持 - [PX4-Autopilot#21214](https://github.com/PX4/PX4-Autopilot/pull/21214))
- VOXL2 支持改进 - [PX4-Autopilot#21426](https://github.com/PX4/PX4-Autopilot/pull/21426)
- Cubepilot Cube Black检测：修复Cube Black与Pixhawk 2在CAN1连接时的检测问题 - [PX4-Autopilot#21342](https://github.com/PX4/PX4-Autopilot/pull/21342)

### 常见功能

- 故障安全状态机重写和[网络模拟](../config/safety_simulation.md)
- 改进的飞行前故障检查报告(需QGC [v4.2.0](https://github.com/mavlink/qgroundcontrol/releases/tag/v4.2.0)或更高版本)：[PX4-Autopilot#20030](https://github.com/PX4/PX4-Autopilot/pull/20030) 和 [qgroundcontrol#10362](https://github.com/mavlink/qgroundcontrol/pull/10362)
- [任务中的包裹投递](../advanced/package_delivery.md)：针对包裹投递应用，新增了任务中机械夹执行器的初始支持
- 手动控制设定点消息重新定义：`manual_control_setpoint.x`, `y`, `z`, `w` -> `roll`, `pitch`, `yaw`, `throttle`；`油门量程 [0,1] -> [-1,1]` - [PX4-Autopilot#15949](https://github.com/PX4/PX4-Autopilot/pull/15949)
- 默认电机PWM配置 - [PX4-Autopilot#21800](https://github.com/PX4/PX4-Autopilot/pull/21800)
- 修复PWM/Oneshot校准 - [PX4-Autopilot#21726](https://github.com/PX4/PX4-Autopilot/pull/21726)

### 控制

- 任务中着陆并再次起飞：当任务未完成时着陆不会解除武装 - [PX4-Autopilot#19659](https://github.com/PX4/PX4-Autopilot/pull/19659)
- 独立轨迹设定值消息：消息现已与机体本地位置设定值消息分离 - [PX4-Autopilot#19622](https://github.com/PX4/PX4-Autopilot/pull/19622)
- 修正起飞或模式切换时的"无效设定值"提示：该提示会因时机问题出现误报 - [PX4-Autopilot#20581](https://github.com/PX4/PX4-Autopilot/pull/20581)
- 修正高度到位置模式切换的阶跃响应：以速度切换高度到位置模式时会产生阶跃抖动 - [PX4-Autopilot#20905](https://github.com/PX4/PX4-Autopilot/pull/20905)

### 估计

- [多高度源融合](../advanced_config/tuning_the_ecl_ekf.md#height)
- EKF2 在无磁力计和气压计数据情况下的启动：此前运行 EKF2 必须依赖磁力计和气压计 - [PX4-Autopilot#20021](https://github.com/PX4/PX4-Autopilot/pull/20021)
- 多旋翼风估计改进：更精确的 bluff body drag 模型 - [PX4-Autopilot#20848](https://github.com/PX4/PX4-Autopilot/pull/20848)

### 传感器

- [DroneCAN传感器现在需要通过`UAVCAN_SUB_*`参数单独启用](../dronecan/index.md#dronecan-subscriptions-publications) - [PX4-Autopilot#18471](https://github.com/PX4/PX4-Autopilot/pull/18471)
- 电池估算默认值及报告改进：默认值：基于电流的负载补偿、更高的空电电压、更短的触发延迟 - [PX4-Autopilot#19429](https://github.com/PX4/PX4-Autopilot/pull/19429), [PX4-Autopilot#19700](https://github.com/PX4/PX4-Autopilot/pull/19700), [PX4-Autopilot#19594](https://github.com/PX4/PX4-Autopilot/pull/19594), https://github.com/PX4/PX4-Autopilot/pull/19679
- SF45旋转激光雷达串口驱动 - [PX4-Autopilot#19891](https://github.com/PX4/PX4-Autopilot/pull/19891)

### 模拟

- [Gazebo] PX4 的 Ignition Fuel：PX4 现在在 Ignition Fuel 中拥有 Gazebo 模型仓库 - https://app.gazebosim.org/PX4
- [Gazebo] Gazebo garden 的支持（原生 Ignition 传输支持）：新增原生 Ignition 传输支持以实现与 Gazebo 和模拟器的直接交互。支持的机体包括 X500（多旋翼）、Plane、Standard VTOL - [PX4-Autopilot#20319](https://github.com/PX4/PX4-Autopilot/pull/20319)
- [Gazebo-classic] Gazebo 嗅探器序列化器：新增用于序列化 Gazebo 相关信息的嗅探器 - [PX4-SITL_gazebo-classic#937](https://github.com/PX4/PX4-SITL_gazebo-classic/pull/937)
- [Gazebo-classic] 电机故障插件更新为 ros2 插件：电机故障插件已更新为 ros2 插件 - [PX4-SITL_gazebo-classic#862](https://github.com/PX4/PX4-SITL_gazebo-classic/pull/862)
- [Gazebo-classic] 全向飞行器模型新增：Gazebo SITL 新增了完全可控的全向机体模型 - https://github.com/PX4/PX4-SITL_gazebo-classic/pull/866
- [Gazebo-classic] 先进升力阻力插件新增：基于 AVL 的非线性气动模型先进升力阻力插件 - [PX4-SITL_gazebo-classic#901](https://github.com/PX4/PX4-SITL_gazebo-classic/pull/901)
- [Gazebo-classic] 安全着陆测试场景新增：新增用于安全着陆测试的场景 - [PX4-SITL_gazebo-classic#93](https://github.com/PX4/PX4-SITL_gazebo-classic/pull/93)
- [Gazebo-classic] Ubuntu Bionic 测试因版本停更移除：由于 Ubuntu Bionic 已停止支持，移除了相关测试 - [PX4-SITL_gazebo-classic#974](https://github.com/PX4/PX4-SITL_gazebo-classic/pull/974)
- [SIH] 树结构中独立传感器模拟模块：原本 SIH 中的树结构传感器模拟功能现已独立为传感器模块。包含磁力计、GPS、气压计、空速计等传感器 - [PX4-Autopilot#20137](https://github.com/PX4/PX4-Autopilot/pull/20137), https://github.com/PX4/PX4-Autopilot/tree/main/src/modules/simulation/sensor_airspeed_sim
- [SIH] 电池模拟故障注入 - https://github.com/PX4/PX4-Autopilot/commit/ebc1d7544e8146788c9e7cf5e8b64f60199240e4

### MAVLink

- 通过USB转发MAVLink：默认情况下通过USB转发MAVLink通信流量 - [PX4-Autopilot#20745](https://github.com/PX4/PX4-Autopilot/pull/20745)

### 多旋翼

- 改进的跟随我飞行模式：优化跟随我模式以提升用户体验 - [PX4-Autopilot#18026](https://github.com/PX4/PX4-Autopilot/pull/18026) | [PX4 Dev Summit presentation](https://www.youtube.com/watch?v=rYYso87cmxA)
- 改进的直升机支持：[Helicopter Configuration](../config_heli/index.md)
- 多旋翼基于方向的速度限制：可分别定义前向、后向和侧向速度 - [PX4-Autopilot#19257](https://github.com/PX4/PX4-Autopilot/pull/19257)
- 允许在悬停模式下偏航：允许在保持悬停模式时操控无人机偏航 - [PX4-Autopilot#21399](https://github.com/PX4/PX4-Autopilot/pull/21399)

### VTOL

- Quad-chute：启用以重置故障状态。当操作员触发再次转换到FW模式时重置故障状态 - [PX4-Autopilot#20913](https://github.com/PX4/PX4-Autopilot/pull/20913)
- 简化Tailsitter在Stabilized模式下的过渡：根据配置的最大倾斜设置自动调整倾斜阈值 - [PX4-Autopilot#21582](https://github.com/PX4/PX4-Autopilot/pull/21582)
- 重构未命令下降的Quad-Chute：启用设置高度误差阈值以触发Quad-chute - [PX4-Autopilot#21598](https://github.com/PX4/PX4-Autopilot/pull/21598)
- 启用无控制面的Quad-tailsitters：启用在tailsitters的FW模式下使用差分推力控制全机身姿态 - [PX4-Autopilot#20511](https://github.com/PX4/PX4-Autopilot/pull/20511)
- 如果已在空中则跳过VTOL_Takeoff任务项 - [PX4-Autopilot#19985](https://github.com/PX4/PX4-Autopilot/pull/19985)

### 固定翼

- 襟翼/扰流板重构 — [PX4-Autopilot#19329](https://github.com/PX4/PX4-Autopilot/pull/19329)
- 固定翼位置控制：从 L1 转换为 NPFG 指导 — [PX4-Autopilot#19603](https://github.com/PX4/PX4-Autopilot/pull/19603) | [PX4 Dev Summit 演示视频](https://www.youtube.com/watch?v=LY6hYBCdy-0)
- 在空中自动应用学习到的空速比例 — [PX4-Autopilot#19787](https://github.com/PX4/PX4-Autopilot/pull/19787)
- 起飞重构/增强 — [PX4-Autopilot#19869](https://github.com/PX4/PX4-Autopilot/pull/19869)
- 固定翼着陆重构/增强 — [PX4-Autopilot#19871](https://github.com/PX4/PX4-Autopilot/pull/19871)
- 根据风速调整最小空速 固定翼位置控制：添加选项以根据风速调整最小空速 — [PX4-Autopilot#20259](https://github.com/PX4/PX4-Autopilot/pull/20259)
- 改进手抛起飞 — [PX4-Autopilot#20557](https://github.com/PX4/PX4-Autopilot/pull/20557)
- 改进加速失速保护 — [PX4-Autopilot#20636](https://github.com/PX4/PX4-Autopilot/pull/20636)
- 添加禁用手动偏航输入的选项 — [PX4-Autopilot#20647](https://github.com/PX4/PX4-Autopilot/pull/20647)
- 禁用空速率输入 TECS 空速率估计的空速率输入已被证明不可靠，因此我们决定暂时禁用 — [PX4-Autopilot#21317](https://github.com/PX4/PX4-Autopilot/pull/21317)
- 支持以不同空速飞行 在 TECS 中添加空速与油门配平映射以支持以不同空速飞行 — [PX4-Autopilot#21345](https://github.com/PX4/PX4-Autopilot/pull/21345)
- 固定翼位置控制：导航航点 — 修复已过航点的逻辑 — [PX4-Autopilot#21642](https://github.com/PX4/PX4-Autopilot/pull/21642)