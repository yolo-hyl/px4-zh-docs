

# 版本1.12

- [版本1.12](#release-1-12)
  - [预发布版本](#预发布版本)
  - [更改内容](#更改)
    - [通用](#通用)
    - [传感器](#传感器)
    - [硬件](#硬件)
    - [MAVLink](#MAVLink)
    - [Commander](#Commander)
    - [Multicopter](#多旋翼)
    - [VTOL](#VTOL)
    - [控制](#控制)
    - [GPS](#GPS)
    - [NuttX](#NuttX)
    - [UAVCAN](#UAVCAN)

## 预发布版本

- [测试版 4](https://github.com/PX4/PX4-Autopilot/releases/tag/v1.12.0-beta4)
- [测试版 3](https://github.com/PX4/PX4-Autopilot/releases/tag/v1.12.0-beta3)
- [测试版 2](https://github.com/PX4/PX4-Autopilot/releases/tag/v1.12.0-beta2)
- [测试版 1](https://github.com/PX4/PX4-Autopilot/releases/tag/v1.12.0-beta1)

## 更改

### 通用

- **基于剩余飞行距离的RTL触发器 ([PR#16399](https://github.com/PX4/PX4-Autopilot/pull/16399))**
  - 计算返航所需时间，考虑机体速度、风速以及目的地距离/方向
- **预判地理围栏违规 ([PR#16400](https://github.com/PX4/PX4-Autopilot/pull/16400))**
  - 如果预测当前轨迹会导致违规，则触发违规，允许机体重新规划路线至安全悬停位置
- **机体脚本**
  - 设置默认值的语法已更改，自定义脚本需要更新
  - 示例请参见 [PR#16796](https://github.com/PX4/PX4-Autopilot/pull/16796/files#diff-dcf2f5536f47f260e5e0ff3b3fd22eaef6b6c510126463d70affa0eb7bd4d3ddL20)
- 安全开关默认关闭（电机解除武装，但舵机/襟翼可移动）
- 安全开关为自锁式：一旦禁用，将保持禁用状态
- 着陆检测器：如果存在距离传感器，扩展着陆检测以使用地面距离
- 新增对IRC Ghost（含遥测）的支持

### 传感器

- 磁力计校准更快且更稳健
  - 新增软铁校准系数
  - 自动确定外部传感器的旋转方向
- 优化速率控制传感器流水线(最小内环端到端延迟)

### 硬件

该版本新增了以下开发板、外设和配件的硬件支持：

- Pixhawk FMUv6U ([在[Pixhawk GitHub Repository](https://github.com/pixhawk/Pixhawk-Standards)上了解此规格详情)
- Pixhawk FMUv6X ([在[Pixhawk GitHub Repository](https://github.com/pixhawk/Pixhawk-Standards)上了解此规格详情)
- CUAV X7 / X7Pro ([在制造商网站上了解此产品的更多信息](http://www.cuav.net/en/x7en/)]
- CUAV Nora ([在制造商网站上了解此产品的更多信息](http://www.cuav.net/en/nora/))
- CUAV CAN GPS ([在制造商网站上了解此产品的更多信息](http://www.cuav.net/en/neo-3-2/))
- SP Racing H7 Extreme ([在制造商网站上了解此产品的更多信息](http://seriouslypro.com/spracingh7extreme))
- Bitcraze Crazyflie v2.1 ([在制造商网站上了解此产品的更多信息](https://www.bitcraze.io/products/crazyflie-2-1/))
- ARK CAN Flow ([在制造商网站上了解此产品的更多信息](https://arkelectron.com/product/ark-flow/))
- mRo Ctrl Zero H7 (Experimental) ([在制造商网站上了解此产品的更多信息](https://store.mrobotics.io/mRo-Control-Zero-F7-p/mro-ctrl-zero-f7.htm))

以下内容已移除：

- 移除了已停产的Intel AeroFC

### MAVLink

- **MAVLink 以太网配置 ([PR#14460](https://github.com/PX4/PX4-Autopilot/pull/14460))**
  - 以太网通道设置（如 UDP 端口、远程端口和广播模式）现在可通过参数动态更改。
- **支持查询 `COMPONENT_INFORMATION` ([PR#16039](https://github.com/PX4/PX4-Autopilot/pull/16039))**
  - 参数元数据现在会与 QGC 每日自动同步。
  - 此新消息允许任何 MAVLink 系统向飞控请求丰富的分层信息，例如了解任务中支持哪些指令或获取参数元数据。该消息的引入主要是为了帮助地面站更好地理解飞控系统（RFC: [mavlink#1339](https://github.com/mavlink/mavlink/issues/1339)）

### Commander

- **Commander: 使用控制模式标志并清理上锁/解锁逻辑 ([PR#16266](https://github.com/PX4/PX4-Autopilot/pull/16266))**
  - 合并分散在arm_disarm()中的上锁要求，并在commander中保留`vehicle_control_mode`的最后状态
- **Commander: 分离手动控制设定值处理 ([PR#16878](https://github.com/PX4/PX4-Autopilot/pull/16878))**
  - 添加一个新的类`ManualControl`用于处理`manual_control_setpoint`，并处理遥控器丢失、遥控器覆盖以及遥控器上锁/解锁

### 多旋翼

- **位置模式下更直观的摇杆手感**

  - 水平摇杆输入映射到加速度而非速度设定值
  - 消除达到最大速度时意外的倾斜变化
  - 起降时更直观的推力响应
  - 可通过 [MPC_POS_MODE](../advanced_config/parameter_reference.md#MPC_POS_MODE) 选择退出
  - 开发记录：[首次尝试](https://github.com/PX4/PX4-Autopilot/pull/12072)，[引入](https://github.com/PX4/PX4-Autopilot/pull/16052)，[改进](https://github.com/PX4/PX4-Autopilot/pull/16320)，[零振荡修复](https://github.com/PX4/PX4-Autopilot/pull/16786)，[位置解锁修复](https://github.com/PX4/PX4-Autopilot/pull/16791)，[无效设定值修复](https://github.com/PX4/PX4-Autopilot/pull/17078)，[起飞前高推力修复](https://github.com/PX4/PX4-Autopilot/pull/17437)

- **悬停推力独立的速度控制增益**

  - 参数 `MPC_{XY/Z}_VEL_{P/I/D}` 已替换为 `MPC_{XY/Z}_VEL_{P/I/D}_ACC`，参见：
    [MPC_XY_VEL_P_ACC](../advanced_config/parameter_reference.md#MPC_XY_VEL_P_ACC)，[MPC_XY_VEL_I_ACC](../advanced_config/parameter_reference.md#MPC_XY_VEL_I_ACC)，[MPC_XY_VEL_D_ACC](../advanced_config/parameter_reference.md#MPC_XY_VEL_D_ACC)，[MPC_Z_VEL_P_ACC](../advanced_config/parameter_reference.md#MPC_Z_VEL_P_ACC)，[MPC_Z_VEL_I_ACC](../advanced_config/parameter_reference.md#MPC_Z_VEL_I_ACC)，[MPC_Z_VEL_D_ACC](../advanced_config/parameter_reference.md#MPC_Z_VEL_D_ACC)

    :::warning 增益具有新含义

    - 从速度误差 $m/s$ 到加速度输出 $m/s^2$ 的缩放
    - 现有增益需大致按 $gravitational\_constant / hover\_thrust$ 因子重新缩放
    - 自动参数转换假设50%悬停推力：`~10m/s^2 / 50% = 20 m/s^2`
      参见 [问题](https://github.com/PX4/PX4-Autopilot/pull/14823#issuecomment-791357646)
      :::

  - 开发记录：[逻辑引入](https://github.com/PX4/PX4-Autopilot/pull/14749)，[参数替换](https://github.com/PX4/PX4-Autopilot/pull/14823)

- **改进圆滑转弯 ([PR#16376](https://github.com/PX4/PX4-Autopilot/pull/16376))**
  - 多旋翼任务中航路点处的圆滑转弯（使用L1风格的拐角引导逻辑）
  - 参见 [任务模式 > 航路点间轨迹](../flight_modes_fw/mission.md#rounded-turns-inter-waypoint-trajectory) 和 [任务 > 接受半径/转弯半径设置](../flying/missions.md#setting-acceptance-turning-radius)
- **移除Rattitude飞行模式 ([PR#17019](https://github.com/PX4/PX4-Autopilot/pull/17019))**
  - 如果您需要恢复此功能，请告知我们。

### VTOL

- **RTL改进 ([PR#16377](https://github.com/PX4/PX4-Autopilot/pull/16377))**
  - 强化了RTL安全保护机制，考虑了在尝试降落时的各种边界情况，具体取决于当前机体模式（多旋翼 vs 固定翼）
- 固定翼/VTOL重大TECS改进

### 控制

- **动态陷波滤波器通过陀螺仪FFT进行更新 ([PR#16385](https://github.com/PX4/PX4-Autopilot/pull/16385))**
  - 向陀螺仪控制数据添加动态陷波滤波，从而实现更平滑的控制
- **Multi-EKF 默认启用** 在stm32f7和stm32h7板上

### GPS

- GPS协议现在默认使用u-blox以加快启动速度，如果使用其他GPS则需要修改[GPS_x_PROTOCOL](../advanced_config/parameter_reference.md#GPS_1_PROTOCOL)

### NuttX

Nuttx 已从 [8.2+ 升级到 NuttX 10.10.0+](https://github.com/apache/incubator-nuttx/compare/nuttx-8.2..nuttx-10.0.1) (@ [904a602c74dc08a100b5c2bd490807de19e73e10](https://github.com/apache/incubator-nuttx/commit/904a602c74dc08a100b5c2bd490807de19e73e10))

- **SD卡性能：** 在 H7 目标上实现更优性能
  - [**BACKPORT**] stm32:SDIO:无论卡时钟频率如何，均使用250毫秒数据路径超时
  - [**BACKPORT**] stm32h7:SDMMC:无论卡时钟频率如何，均使用250毫秒数据路径超时
  - [**BACKPORT**] stm32f7:SDMMC:无论卡时钟频率如何，均使用250毫秒数据路径超时
  - [**BACKPORT**] 修复 SDMMC 驱动事件等待逻辑中的竞争条件
  - [**BACKPORT**] mmcsd:移除 CONFIG_ARCH_HAVE_SDIO_DELAYED_INVLDT，解决1位模式卡顿问题
- **以太网稳定性：**
  - [**BACKPORT**] stm32x7:以太网修复因帧过大导致的硬故障
  - [**BACKPORT**] stm32:以太网修复帧过大问题
- **启动稳定性 V5-V6X 确保 LSE (RTC) 振荡器启动**

  - [**BACKPORT**] stm32h7:lse 修复 Kconfig help 文本
  - [**BACKPORT**] stm32f7:lse 直接使用 Kconfig 值
  - [**BACKPORT**] stm32h7:添加 DBGMCU
  - [**BACKPORT**] stm32f7:添加自动选择 LSE CAPABILITY 选项
  - [**BACKPORT**] stm32h7:添加自动选择 LSE CAPABILITY 选项

    ::: info
    该旋钮将从低到高循环尝试正确的*值
    为避免损坏晶体，应使用能启动振荡器的最低设置
    参见应用笔记 AN2867
    *会根据硅晶片版本使用正确的代码点实现驱动强度
    参见勘误表 ES0392 Rev 7 2.2.14 LSE 振荡器驱动能力选择位已交换
    :::

- **驱动变更**

  - [**BACKPORT**] drivers/serial:修复 cdcacm 的 Rx 中断使能
  - [**BACKPORT**] binnfmt:在关闭 ELF 文件描述符前修复返回

  - [**BACKPORT**] stm32f7:允许复用 OTG_ID GPIO
  - [**BACKPORT**] stm32f7:SDMMC 修复 do_gpio 复位
  - [**BACKPORT**] stm32h7:串口使用 dma tx 信号量作为资源持有者
  - [**BACKPORT**] stm32h7:SDMMC 修复 do_gpio 复位
  - [**BACKPORT**] stm32h7:串口添加 RX 和 TX DMA
  - [**BACKPORT**] stm32h7:允许复用 OTG_ID GPIO

  - [**BACKPORT**] Kinetis:kinetis:替换 DMA
  - [**BACKPORT**] kinetis:串口使用 eDMA
  - [**BACKPORT**] kinetis:SPI 使用 eDMA
  - [**BACKPORT**] Kinetis:串口无需 DMA 轮询

  - [**BACKPORT**] libc/stdio: 为无控制台目标预分配 stdin, stdout 和 stderr

- **FlexCan 修复**
  - [**BACKPORT**][flexcan] 修正 CTRL1 寄存器的复位状态
  - [**BACKPORT**][flexcan] 修复 TX 丢包 #2792 并正确设置非零 CAN 时序寄存器
  - [**BACKPORT**] FlexCAN 修复 TX 中止流程
- **CAN 引导加载程序支持**
  - [**BACKPORT**] s32k1xx:支持 ramfunc
- **STM32F412 清理**
- [**BACKPORT**] stm32f412:修正引脚数量
- [**BACKPORT**] stm32f412:使用 SoC 引脚映射替换临时方案
- [**BACKPORT**] stm32412:修复 CAN1 引脚映射
- **安全补丁**
- [**BACKPORT**] tcp: 移除 TCP 重组的不完整支持
- [**BACKPORT**] net/tcp/tcp_input.c: 修正紧急数据长度的错误检查
- [**BACKPORT**] libc: 为 malloc realloc 和 memalign 添加额外检查
- **IMXRT 修复**
- 为 IMXRT 添加单线模式和正确校验设置以支持 sbus 等协议
- [**BACKPORT**] imxrt:串口支持单线模式
- [**BACKPORT**] imxrt:imxrt_lowputc 修复校验设置
- **STM32H7 改进**
- [**BACKPORT**] stm32h7:SPI 修复16位SPI模式
- [**BACKPORT**] stm32h7:DMA BDMA 在完成时不会自动禁用
- [**BACKPORT**] 修复 SRAM4 中静态数据被堆覆盖的问题
- [**BACKPORT**] stm32h7:SDMMC 修复 do_gpio 复位

### UAVCAN

- UAVCANv0: 虽然CAN节点的基本功能（如固件升级和参数同步）已实现5年以上，但如今我们更新了支持，因为相关设备终于上市了。典型CAN GPS、空速计和电源模块已获得支持
- UAVCANv0 Node: PX4过去多年已支持构建节点 - 现在我们支持构建特定目标，例如CUAV GPS单元
- UAVCANv1: 完整端到端实现的初始测试版